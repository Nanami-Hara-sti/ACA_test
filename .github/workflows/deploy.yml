name: Build, Push to GHCR and Deploy to Container Apps

# mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

# GHCRã«æ›¸ãè¾¼ã¿ã€Azureã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®æ¨©é™
permissions:
  contents: read
  packages: write
  id-token: write # Azure OpenID Connectç”¨

env:
  REGISTRY: ghcr.io
  AZURE_RESOURCE_GROUP: 'rg-test-hara'
  AZURE_CONTAINER_APP_ENVIRONMENT: 'ca-env-test'
  BACKEND_APP_NAME: 'rg-test-hara-ca-back'
  FRONTEND_APP_NAME: 'rg-test-hara-ca-front'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      backend-image: ${{ steps.backend-meta.outputs.image-name }}
      frontend-image: ${{ steps.frontend-meta.outputs.image-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set lowercase owner
        id: lowercase
        run: echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.ACA_DEPLOY_TOKEN }} # Personal Access Tokenã‚’ä½¿ç”¨

      # --- Backend ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼†ãƒ—ãƒƒã‚·ãƒ¥ ---
      - name: Set backend image metadata
        id: backend-meta
        run: |
          echo "image-name=ghcr.io/${{ steps.lowercase.outputs.owner_lc }}/my-test-backend:${{ github.sha }}" >> $GITHUB_OUTPUT
          
      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          # ã‚¤ãƒ¡ãƒ¼ã‚¸å (ä¾‹: ghcr.io/nanami-hara-sti/my-test-backend:latest)
          tags: |
            ghcr.io/${{ steps.lowercase.outputs.owner_lc }}/my-test-backend:${{ github.sha }}
            ghcr.io/${{ steps.lowercase.outputs.owner_lc }}/my-test-backend:latest

      # --- Frontend ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼†ãƒ—ãƒƒã‚·ãƒ¥ ---
      - name: Set frontend image metadata
        id: frontend-meta
        run: |
          echo "image-name=ghcr.io/${{ steps.lowercase.outputs.owner_lc }}/my-test-frontend:${{ github.sha }}" >> $GITHUB_OUTPUT
          
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./frontend/Dockerfile
          target: production # æ˜ç¤ºçš„ã«productionã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æŒ‡å®š
          push: true
          build-args: |
            VITE_API_BASE_URL=https://rg-test-hara-ca-back.blackrock-912602d1.westus.azurecontainerapps.io
          tags: |
            ghcr.io/${{ steps.lowercase.outputs.owner_lc }}/my-test-frontend:${{ github.sha }}
            ghcr.io/${{ steps.lowercase.outputs.owner_lc }}/my-test-frontend:latest

  # Container Appsã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–
  deploy-to-containerapp:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ä¸€æ™‚çš„ã«Azureèªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®æƒ…å ±ã‚’æä¾›
      - name: Skip Azure Auth and Provide Manual Deploy Info
        run: |
          echo "ğŸ”§ Azureèªè¨¼è¨­å®šãŒå¿…è¦ã§ã™ã€‚ç¾åœ¨ã¯æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®æƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚"
          echo ""
          echo "âœ… ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸:"
          echo "Backend:  ${{ needs.build-and-push.outputs.backend-image }}"
          echo "Frontend: ${{ needs.build-and-push.outputs.frontend-image }}"
          echo ""
          echo "ğŸ“‹ æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰:"
          echo "# Backend ãƒ‡ãƒ—ãƒ­ã‚¤"
          echo "az containerapp update \\"
          echo "  --name ${{ env.BACKEND_APP_NAME }} \\"
          echo "  --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \\"
          echo "  --image ${{ needs.build-and-push.outputs.backend-image }} \\"
          echo "  --set-env-vars ENVIRONMENT=production SQL_SERVER_NAME='rg-test-hara.database.windows.net' SQL_DATABASE_NAME='rg-test-hara-SQL'"
          echo ""
          echo "# Frontend ãƒ‡ãƒ—ãƒ­ã‚¤"  
          echo "az containerapp update \\"
          echo "  --name ${{ env.FRONTEND_APP_NAME }} \\"
          echo "  --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \\"
          echo "  --image ${{ needs.build-and-push.outputs.frontend-image }} \\"
          echo "  --set-env-vars VITE_API_BASE_URL='https://rg-test-hara-ca-back.blackrock-912602d1.westus.azurecontainerapps.io'"

      # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
      - name: Generate deployment script
        run: |
          cat << 'EOF' > deploy-from-github.sh
          #!/bin/bash
          # GitHub Actionsã§ç”Ÿæˆã•ã‚ŒãŸè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
          set -e
          
          echo "ğŸš€ Container Appsè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™..."
          
          # å¤‰æ•°è¨­å®š
          BACKEND_IMAGE="${{ needs.build-and-push.outputs.backend-image }}"
          FRONTEND_IMAGE="${{ needs.build-and-push.outputs.frontend-image }}"
          
          echo "ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸:"
          echo "  Backend:  $BACKEND_IMAGE"
          echo "  Frontend: $FRONTEND_IMAGE"
          echo ""
          
          # Backend ãƒ‡ãƒ—ãƒ­ã‚¤
          echo "ğŸ“¦ Backendã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
          az containerapp update \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $BACKEND_IMAGE \
            --set-env-vars ENVIRONMENT=production SQL_SERVER_NAME="rg-test-hara.database.windows.net" SQL_DATABASE_NAME="rg-test-hara-SQL"
          
          echo "âœ… Backend ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          
          # Frontend ãƒ‡ãƒ—ãƒ­ã‚¤
          echo "ğŸ“¦ Frontendã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
          az containerapp update \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $FRONTEND_IMAGE \
            --set-env-vars VITE_API_BASE_URL="https://rg-test-hara-ca-back.blackrock-912602d1.westus.azurecontainerapps.io"
          
          echo "âœ… Frontend ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          
          # URLè¡¨ç¤º
          echo ""
          echo "ğŸŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URL:"
          echo "Backend:  https://rg-test-hara-ca-back.blackrock-912602d1.westus.azurecontainerapps.io"
          echo "Frontend: https://rg-test-hara-ca-front.blackrock-912602d1.westus.azurecontainerapps.io"
          echo ""
          echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†!"
          EOF
          
          chmod +x deploy-from-github.sh
          
          echo "ğŸ“„ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: deploy-from-github.sh"
          echo "å®Ÿè¡Œæ–¹æ³•: bash deploy-from-github.sh"
